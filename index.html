<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lista remontowa</title>

  <!-- Podpięcie zewnętrznego pliku CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDK (wersja modułowa) -->
  <script type="module">
    /*********************
     * IMPORTY FIREBASE *
     *********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /*********************
         * MENU EDYCJI *
         *********************/
        /*********************
         * MENU EDYCJI (formularz) *
         *********************/
        el.querySelector(".menu").addEventListener("click", () => {
          // Overlay (ciemne tło)
          const overlay = document.createElement("div");
          overlay.style.position = "fixed";
          overlay.style.inset = "0";
          overlay.style.background = "rgba(0,0,0,0.4)";
          overlay.style.display = "flex";
          overlay.style.alignItems = "center";
          overlay.style.justifyContent = "center";
          overlay.style.zIndex = "999";

          // Formularz edycji
          overlay.innerHTML = `
            <form class="edit-section" style="max-width:400px; width:100%; background:#fff;">
              <h3>Edycja</h3>
              <input name="name" value="${d.name || ''}" placeholder="Nazwa" />
              <textarea name="desc" placeholder="Opis">${d.desc || ''}</textarea>
              <input name="price" type="number" step="0.01" value="${d.price || 0}" placeholder="Cena" />
              <input name="qty" type="number" value="${d.qty || 1}" placeholder="Ilość" />
              <input name="image" value="${d.image || ''}" placeholder="Link do zdjęcia" />
              <input name="link" value="${d.link || ''}" placeholder="Link do sklepu" />
              <input name="pin" type="number" inputmode="numeric" placeholder="PIN" required />
              <button type="submit">Zapisz zmiany</button>
              <button type="button" class="delete">Usuń</button>
              <button type="button" class="close">Anuluj</button>
            </form>
          `;

          document.body.appendChild(overlay);
          const form = overlay.querySelector("form");

          // Zapis zmian
          form.addEventListener("submit", async e => {
            e.preventDefault();
            if (form.pin.value !== "1337") return alert("Zły PIN");

            await updateDoc(doc(db, "items", d.id), {
              name: form.name.value,
              desc: form.desc.value,
              price: parseFloat(form.price.value),
              qty: parseInt(form.qty.value),
              image: form.image.value,
              link: form.link.value
            });

            overlay.remove();
          });

          // Usuwanie
          overlay.querySelector(".delete").addEventListener("click", async () => {
            if (form.pin.value !== "1337") return alert("Podaj PIN");
            await deleteDoc(doc(db, "items", d.id));
            overlay.remove();
          });

          // Anulowanie
          overlay.querySelector(".close").addEventListener("click", () => overlay.remove());
        });

        listEl.appendChild(el);
      });

      // Aktualizacja sumy
      totalEl.textContent = total.toFixed(2) + " zł";
    }

    /*********************
     * NASŁUCH FIRESTORE *
     *********************/
    onSnapshot(itemsRef, snap => {
      currentItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderList();
    });

    /*********************
     * DODAWANIE ELEMENTU *
     *********************/
    formEl.addEventListener("submit", async e => {
      e.preventDefault();

      const pin = document.getElementById("pin").value;
      if (pin !== "1337") return alert("Zły PIN");

      await addDoc(itemsRef, {
        name: formEl.name.value,
        desc: formEl.desc.value,
        price: parseFloat(formEl.price.value),
        qty: parseInt(formEl.qty.value),
        image: formEl.image.value,
        link: formEl.link.value,
        skipPrice: false
      });

      formEl.reset();
    });
  </script>
</head>
<body>

  <!-- Górne menu -->
  <nav>
    <button onclick="document.getElementById('addForm').style.display='none'">LISTA</button>
    <button onclick="document.getElementById('addForm').style.display='flex'">DODAJ</button>
  </nav>

  <!-- Formularz dodawania -->
  <form id="addForm" style="display:none">
    <input name="name" placeholder="Nazwa" required />
    <textarea name="desc" placeholder="Opis (ENTER = nowa linia)"></textarea>
    <input name="price" type="number" step="0.01" placeholder="Cena" required />
    <input name="qty" type="number" value="1" placeholder="Ilość" />
    <input name="image" placeholder="Link do zdjęcia" />
    <input name="link" placeholder="Link do sklepu" />
    <input id="pin" type="number" inputmode="numeric" placeholder="PIN" required />
    <button type="submit">Dodaj</button>
  </form>

  <!-- Lista elementów -->
  <div id="list"></div>

  <!-- Stopka z sumą -->
  <footer>
    Suma: <span id="total">0.00 zł</span>
  </footer>

</body>
</html>
