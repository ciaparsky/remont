<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lista remontowa</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav>
  <button id="btnList">LISTA</button>
  <button id="btnAdd">DODAJ</button>
</nav>

<form id="addForm" style="display:none">
  <input id="name" placeholder="Nazwa" required />
  <textarea id="desc" placeholder="Opis"></textarea>

  <input
    id="price"
    type="number"
    step="0.01"
    min="0"
    placeholder="Cena (zł)"
    required
  />

  <input id="qty" type="number" min="1" value="1" required />
  <input id="image" placeholder="URL zdjęcia" />
  <input id="link" placeholder="Link do sklepu" />
  <input id="pin" type="password" placeholder="PIN" required />

  <button type="submit">Dodaj</button>
</form>

<div id="list"></div>

<footer>
  Suma: <strong id="total">0.00 zł</strong>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    deleteDoc,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // ===== FIREBASE CONFIG (WCZORAJSZE DANE ZOSTAJĄ) =====
  const firebaseConfig = {
    apiKey: "AIzaSyArKqslVsWLUBO4EOPO6AyOyih23Fy6Y8o",
    authDomain: "remont-eryk.firebaseapp.com",
    projectId: "remont-eryk",
    storageBucket: "remont-eryk.firebasestorage.app",
    messagingSenderId: "557601020132",
    appId: "1:557601020132:web:8cf6143a11ba33ca8d74f1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const itemsRef = collection(db, "items");

  const listEl = document.getElementById("list");
  const totalEl = document.getElementById("total");
  const form = document.getElementById("addForm");

  document.getElementById("btnAdd").onclick = () => form.style.display = "block";
  document.getElementById("btnList").onclick = () => form.style.display = "none";

  // ===== WCZYTYWANIE WCZORAJSZYCH DANYCH =====
  onSnapshot(itemsRef, snapshot => {
    console.log("Firestore snapshot:", snapshot.size);

    listEl.innerHTML = "";
    let total = 0;

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const enabled = d.enabled !== false;

      if (enabled) {
        total += (Number(d.price) || 0) * (Number(d.qty) || 1);
      }

      const el = document.createElement("div");
      el.className = "item";

      el.innerHTML = `
        <div class="check">
          <input type="checkbox" ${enabled ? "checked" : ""} />
        </div>

        <img src="${d.image || ""}" alt="" />

        <div class="content">
          <h3>${d.name || "(brak nazwy)"}</h3>

          <details>
            <summary>Opis</summary>
            <p>${d.desc || ""}</p>
          </details>

          <p>Cena: ${(Number(d.price) || 0).toFixed(2)} zł × ${d.qty || 1}</p>

          ${d.link ? `<a href="${d.link}" target="_blank">Sklep</a>` : ""}

          <button class="menu">⋮</button>
        </div>
      `;

      // checkbox
      el.querySelector("input[type=checkbox]").onchange = e => {
        updateDoc(doc(db, "items", docSnap.id), {
          enabled: e.target.checked
        });
      };

      // menu
      el.querySelector(".menu").onclick = () => {
        const pin = prompt("PIN:");
        if (pin !== "1337") return;

        if (confirm("Usunąć pozycję?")) {
          deleteDoc(doc(db, "items", docSnap.id));
        }
      };

      listEl.appendChild(el);
    });

    totalEl.textContent = total.toFixed(2) + " zł";
  });

  // ===== DODAWANIE =====
  form.onsubmit = async e => {
    e.preventDefault();

    if (document.getElementById("pin").value !== "1337") {
      alert("Zły PIN");
      return;
    }

    console.log("Dodawanie do Firestore");

    await addDoc(itemsRef, {
      name: document.getElementById("name").value,
      desc: document.getElementById("desc").value,
      price: Number(document.getElementById("price").value),
      qty: Number(document.getElementById("qty").value),
      image: document.getElementById("image").value,
      link: document.getElementById("link").value,
      enabled: true
    });

    form.reset();
    form.style.display = "none";
  };
</script>

</body>
</html>
