<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lista remontowa</title>

  <!-- Podpięcie zewnętrznego pliku CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDK (wersja modułowa) -->
  <script type="module">
    /*********************
     * IMPORTY FIREBASE *
     *********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /************************
     * KONFIGURACJA FIREBASE *
     ************************/
    const firebaseConfig = {
      apiKey: "AIzaSyArKqslVsWLUBO4EOPO6AyOyih23Fy6Y8o",
      authDomain: "remont-eryk.firebaseapp.com",
      projectId: "remont-eryk",
      storageBucket: "remont-eryk.firebasestorage.app",
      messagingSenderId: "557601020132",
      appId: "1:557601020132:web:8cf6143a11ba33ca8d74f1"
    };

    // Inicjalizacja Firebase i Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Referencja do kolekcji w Firestore
    const itemsRef = collection(db, "items");

    /*********************
     * ELEMENTY DOM *
     *********************/
    const listEl = document.getElementById("list");
    const formEl = document.getElementById("addForm");
    const totalEl = document.getElementById("total");

    let currentItems = [];

    /*********************
     * RENDER LISTY *
     *********************/
    function renderList() {
      listEl.innerHTML = "";
      let total = 0;

      currentItems.forEach(d => {
        const skip = d.skipPrice === true;
        const price = (Number(d.price) || 0) * (Number(d.qty) || 1);
        if (!skip) total += price;

        // Główny kontener elementu
        const el = document.createElement("div");
        el.className = "item";
        el.style.position = "relative";

        el.innerHTML = `
          <!-- Checkbox w prawym górnym rogu – wyklucza z sumy -->
          <div class="check" style="position:absolute; top:8px; right:8px;">
            <input type="checkbox" ${skip ? "checked" : ""} />
          </div>

          <!-- Zdjęcie produktu -->
          <img class="item-image" src="${d.image || ''}" />

          <div class="content">
            <!-- Nazwa -->
            <h3>${d.name || "(brak nazwy)"}</h3>

            <!-- Opis – rozwijany, z zachowaniem ENTERÓW -->
            <details>
              <summary>Opis</summary>
              <p class="desc">${(d.desc || "").replace(/\n/g, "<br>")}</p>
            </details>

            <!-- Cena i ilość -->
            <p>${(Number(d.price) || 0).toFixed(2)} zł × ${d.qty || 1}</p>

            <!-- Dolny pasek: sklep + menu -->
            <div class="bottom">
              ${d.link ? `<a class="shop-link" href="${d.link}" target="_blank">Sklep</a>` : ""}
              <button class="menu">⋮</button>
            </div>
          </div>
        `;

        /*********************
         * OBSŁUGA CHECKBOXA *
         *********************/
        el.querySelector("input[type=checkbox]").addEventListener("change", async e => {
          await updateDoc(doc(db, "items", d.id), { skipPrice: e.target.checked });
        });

        /*********************
         * MENU EDYCJI *
         *********************/
        el.querySelector(".menu").addEventListener("click", () => {
          const pin = prompt("Podaj PIN");
          if (pin !== "1337") return;

          const action = prompt("Wpisz: edit lub delete");
          if (action === "delete") {
            deleteDoc(doc(db, "items", d.id));
          }
        });

        listEl.appendChild(el);
      });

      // Aktualizacja sumy
      totalEl.textContent = total.toFixed(2) + " zł";
    }

    /*********************
     * NASŁUCH FIRESTORE *
     *********************/
    onSnapshot(itemsRef, snap => {
      currentItems = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderList();
    });

    /*********************
     * DODAWANIE ELEMENTU *
     *********************/
    formEl.addEventListener("submit", async e => {
      e.preventDefault();

      const pin = document.getElementById("pin").value;
      if (pin !== "1337") return alert("Zły PIN");

      await addDoc(itemsRef, {
        name: formEl.name.value,
        desc: formEl.desc.value,
        price: parseFloat(formEl.price.value),
        qty: parseInt(formEl.qty.value),
        image: formEl.image.value,
        link: formEl.link.value,
        skipPrice: false
      });

      formEl.reset();
    });
  </script>
</head>
<body>

  <!-- Górne menu -->
  <nav>
    <button onclick="document.getElementById('addForm').style.display='none'">LISTA</button>
    <button onclick="document.getElementById('addForm').style.display='flex'">DODAJ</button>
  </nav>

  <!-- Formularz dodawania -->
  <form id="addForm" style="display:none">
    <input name="name" placeholder="Nazwa" required />
    <textarea name="desc" placeholder="Opis (ENTER = nowa linia)"></textarea>
    <input name="price" type="number" step="0.01" placeholder="Cena" required />
    <input name="qty" type="number" value="1" placeholder="Ilość" />
    <input name="image" placeholder="Link do zdjęcia" />
    <input name="link" placeholder="Link do sklepu" />
    <input id="pin" type="number" inputmode="numeric" placeholder="PIN" required />
    <button type="submit">Dodaj</button>
  </form>

  <!-- Lista elementów -->
  <div id="list"></div>

  <!-- Stopka z sumą -->
  <footer>
    Suma: <span id="total">0.00 zł</span>
  </footer>

</body>
</html>
